---
/**
 * FloatingDialogue Component
 *
 * Toast-style soul messages that appear in the bottom-right corner.
 * Supports message queuing and different message types.
 */
---

<div id="soul-dialogue" class="soul-dialogue" role="status" aria-live="polite">
  <div class="soul-dialogue-content">
    <span class="soul-dialogue-icon"></span>
    <span class="soul-dialogue-text"></span>
    <button class="soul-dialogue-dismiss" aria-label="Dismiss">×</button>
  </div>
</div>

<style>
  .soul-dialogue {
    position: fixed;
    bottom: 80px; /* Above SoulHint */
    right: 24px;
    max-width: 320px;
    background: var(--color-background, #ffffff);
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    transform: translateY(20px);
    opacity: 0;
    visibility: hidden;
    transition:
      transform 0.3s cubic-bezier(0.16, 1, 0.3, 1),
      opacity 0.3s ease,
      visibility 0.3s ease;
    z-index: 1000;
  }

  .soul-dialogue.is-visible {
    transform: translateY(0);
    opacity: 1;
    visibility: visible;
  }

  .soul-dialogue-content {
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .soul-dialogue-icon {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-primary, #966a85);
  }

  .soul-dialogue-icon svg {
    width: 20px;
    height: 20px;
  }

  .soul-dialogue-text {
    flex: 1;
    font-size: 14px;
    line-height: 1.5;
    color: var(--color-text, #222);
  }

  .soul-dialogue-dismiss {
    flex-shrink: 0;
    background: none;
    border: none;
    color: var(--color-text-muted, #666);
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    /* 44px touch target with centered × symbol */
    width: 44px;
    height: 44px;
    min-width: 44px;
    min-height: 44px;
    padding: 0;
    margin: -12px -12px -12px 0; /* Negative margin to expand hit area without affecting layout */
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.6;
    transition: opacity 0.2s ease;
  }

  .soul-dialogue-dismiss:hover,
  .soul-dialogue-dismiss:active {
    opacity: 1;
  }

  /* Message types */
  .soul-dialogue[data-type='welcome'] {
    border-left: 3px solid var(--color-primary, #966a85);
  }

  .soul-dialogue[data-type='hint'] {
    border-left: 3px solid var(--color-gold, #d4af37);
  }

  .soul-dialogue[data-type='hint'] .soul-dialogue-icon {
    color: var(--color-gold, #d4af37);
  }

  /* Dark mode */
  :global([data-theme='dark']) .soul-dialogue {
    background: rgba(25, 25, 25, 0.95);
    border-color: rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
  }

  :global([data-theme='dark']) .soul-dialogue-text {
    color: var(--color-text, #f5f5f5);
  }

  :global([data-theme='dark']) .soul-dialogue-dismiss {
    color: rgba(255, 255, 255, 0.5);
  }

  :global([data-theme='dark']) .soul-dialogue-dismiss:hover {
    color: rgba(255, 255, 255, 0.8);
  }

  /* Mobile */
  @media (max-width: 768px) {
    .soul-dialogue {
      bottom: 70px;
      right: 16px;
      left: 16px;
      max-width: none;
    }
  }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .soul-dialogue {
      transition: opacity 0.15s ease, visibility 0.15s ease;
      transform: translateY(0);
    }
  }
</style>

<script>
  interface ToastPayload {
    message: string;
    duration: number;
    type?: 'info' | 'welcome' | 'hint';
    hasHtml?: boolean; // If true, render message as HTML
  }

  // Phosphor icons (SVG)
  const SOUL_ICONS: Record<string, string> = {
    // Spiral - for info/oracle messages
    info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor"><path d="M232,128a104,104,0,0,1-208,0c0-57.44,46.56-104,104-104a8,8,0,0,1,0,16,88.1,88.1,0,0,0-88,88,88,88,0,0,0,176,0,8,8,0,0,1,16,0ZM128,56a72.08,72.08,0,0,0-72,72,8,8,0,0,0,16,0,56.06,56.06,0,0,1,56-56,8,8,0,0,0,0-16Zm0,40a32,32,0,1,0,32,32A32,32,0,0,0,128,96Zm0,48a16,16,0,1,1,16-16A16,16,0,0,1,128,144Z"/></svg>',
    // Sparkle - for welcome messages
    welcome: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor"><path d="M208,144a15.78,15.78,0,0,1-10.42,14.94l-51.65,19-19,51.65a15.92,15.92,0,0,1-29.88,0l-19-51.65-51.65-19a15.92,15.92,0,0,1,0-29.88l51.65-19,19-51.65a15.92,15.92,0,0,1,29.88,0l19,51.65,51.65,19A15.78,15.78,0,0,1,208,144ZM152,48h16V64a8,8,0,0,0,16,0V48h16a8,8,0,0,0,0-16H184V16a8,8,0,0,0-16,0V32H152a8,8,0,0,0,0,16Zm88,32h-8V72a8,8,0,0,0-16,0v8h-8a8,8,0,0,0,0,16h8v8a8,8,0,0,0,16,0V96h8a8,8,0,0,0,0-16Z"/></svg>',
    // Lightbulb - for hint messages
    hint: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor"><path d="M176,232a8,8,0,0,1-8,8H88a8,8,0,0,1,0-16h80A8,8,0,0,1,176,232Zm40-128a87.55,87.55,0,0,1-33.64,69.21A16.24,16.24,0,0,0,176,186v6a16,16,0,0,1-16,16H96a16,16,0,0,1-16-16v-6a16,16,0,0,0-6.23-12.66A87.59,87.59,0,0,1,40,104.49C39.74,56.83,78.26,17.14,125.88,16A88,88,0,0,1,216,104Zm-16,0a72,72,0,0,0-73.74-72c-39,.92-70.47,33.39-70.26,72.39a71.65,71.65,0,0,0,27.64,56.3A32,32,0,0,1,96,186v6h64v-6a32.15,32.15,0,0,1,12.47-25.35A71.65,71.65,0,0,0,200,104Zm-16.11-9.34a57.6,57.6,0,0,0-46.56-46.55,8,8,0,0,0-2.66,15.78c16.57,2.79,30.63,16.85,33.44,33.45a8,8,0,0,0,7.87,6.61,8.54,8.54,0,0,0,1.4-.12A8,8,0,0,0,183.89,94.66Z"/></svg>',
  };

  class SoulDialogue {
    private element: HTMLElement | null;
    private textEl: HTMLElement | null;
    private iconEl: HTMLElement | null;
    private queue: ToastPayload[] = [];
    private isShowing = false;
    private hideTimeout: ReturnType<typeof setTimeout> | null = null;

    constructor() {
      this.element = document.getElementById('soul-dialogue');
      this.textEl = this.element?.querySelector('.soul-dialogue-text') || null;
      this.iconEl = this.element?.querySelector('.soul-dialogue-icon') || null;
      this.init();
    }

    private init(): void {
      // Bind dismiss button on initial load
      this.bindDismissButton();

      // Listen for toast events from dispatch
      document.addEventListener('soul:toast', ((e: CustomEvent<ToastPayload>) => {
        this.show(e.detail);
      }) as EventListener);

      // Click outside to dismiss
      document.addEventListener('click', (e) => {
        if (this.isShowing && this.element && !this.element.contains(e.target as Node)) {
          // Don't dismiss on click if within the first 500ms
          // This prevents accidental dismissal right after showing
        }
      });

      // Handle Astro view transitions
      document.addEventListener('astro:after-swap', () => {
        this.element = document.getElementById('soul-dialogue');
        this.textEl = this.element?.querySelector('.soul-dialogue-text') || null;
        this.iconEl = this.element?.querySelector('.soul-dialogue-icon') || null;
        this.bindDismissButton();
      });
    }

    private bindDismissButton(): void {
      if (!this.element) return;
      const dismissBtn = this.element.querySelector('.soul-dialogue-dismiss');
      dismissBtn?.addEventListener('click', () => this.hide());
    }

    show(payload: ToastPayload): void {
      // If duration is 0 and we're already showing, replace immediately (for loading states)
      if (payload.duration === 0 && this.isShowing) {
        if (this.hideTimeout) {
          clearTimeout(this.hideTimeout);
          this.hideTimeout = null;
        }
        // Replace current message
        this.updateContent(payload);
        return;
      }

      if (this.isShowing) {
        // Queue the message
        this.queue.push(payload);
        return;
      }

      this.isShowing = true;

      if (!this.element || !this.textEl) return;

      // Set content and type
      this.updateContent(payload);
      this.element.classList.add('is-visible');

      // Auto-hide after duration (0 = no auto-hide)
      if (this.hideTimeout) {
        clearTimeout(this.hideTimeout);
      }

      if (payload.duration > 0) {
        this.hideTimeout = setTimeout(() => {
          this.hide();
        }, payload.duration);
      }
    }

    private updateContent(payload: ToastPayload): void {
      if (!this.element || !this.textEl) return;

      // Set content - use innerHTML for HTML content, textContent otherwise
      if (payload.hasHtml) {
        // Basic sanitization: only allow safe tags
        const sanitized = this.sanitizeHtml(payload.message);
        this.textEl.innerHTML = sanitized;
      } else {
        this.textEl.textContent = payload.message;
      }

      // Set icon based on type
      const type = payload.type || 'info';
      if (this.iconEl) {
        this.iconEl.innerHTML = SOUL_ICONS[type] || SOUL_ICONS.info;
      }

      this.element.setAttribute('data-type', type);
    }

    private sanitizeHtml(html: string): string {
      // Remove script tags and event handlers
      let sanitized = html
        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
        .replace(/on\w+="[^"]*"/gi, '')
        .replace(/on\w+='[^']*'/gi, '');

      // Only allow specific tags: a, strong, em, code
      const allowedTags = ['a', 'strong', 'em', 'code', 'b', 'i'];
      const tagPattern = /<\/?([a-z]+)[^>]*>/gi;

      sanitized = sanitized.replace(tagPattern, (match, tag) => {
        const lowerTag = tag.toLowerCase();
        if (allowedTags.includes(lowerTag)) {
          // For <a> tags, ensure safe attributes
          if (lowerTag === 'a') {
            const hrefMatch = match.match(/href="([^"]*)"/i);
            const classMatch = match.match(/class="([^"]*)"/i);
            if (match.includes('</')) return '</a>';
            if (hrefMatch) {
              const href = hrefMatch[1];
              const className = classMatch ? classMatch[1] : '';
              // Only allow relative URLs or https
              if (href.startsWith('/') || href.startsWith('https://')) {
                return `<a href="${href}" class="${className}">`;
              }
            }
            return '';
          }
          return match;
        }
        return '';
      });

      return sanitized;
    }

    hide(): void {
      if (!this.element) return;

      this.element.classList.remove('is-visible');
      this.isShowing = false;

      if (this.hideTimeout) {
        clearTimeout(this.hideTimeout);
        this.hideTimeout = null;
      }

      // Show next queued message
      if (this.queue.length > 0) {
        const next = this.queue.shift()!;
        setTimeout(() => this.show(next), 400);
      }
    }

    // Public API for direct calls
    toast(message: string, duration = 4000, type: ToastPayload['type'] = 'info'): void {
      this.show({ message, duration, type });
    }
  }

  // Initialize and expose globally
  const soulDialogue = new SoulDialogue();
  (window as unknown as Record<string, unknown>).soulDialogue = soulDialogue;
</script>
