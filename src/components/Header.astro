---
import ThemeToggle from './ThemeToggle.astro';

const currentPath = Astro.url.pathname;

const leftNav = [
  { href: '/', label: 'Home' },
  { href: '/portfolio', label: 'Portfolio', hasDropdown: true, dropdownKey: 'portfolio' },
  { href: '#', label: 'A.I./LLMs', hasDropdown: true, dropdownKey: 'ai' },
];

const rightNav = [
  { href: '/about', label: 'About' },
  { href: '/contact', label: 'Contact' },
  { href: 'https://tomdimino.substack.com/', label: 'Blog', external: true },
];

const portfolioItems = [
  { href: '/portfolio/dolby', label: 'Dolby.com' },
  { href: '/portfolio/acs', label: 'The American College of Surgeons' },
  { href: '/portfolio/czi', label: 'Chan Zuckerberg Initiative' },
  { href: '/portfolio', label: 'View All Case Studies' },
];

const aiItems = [
  { href: 'https://www.tomdimino.com/Cognitive-Designing-AI-LLMs.pdf', label: '"Imbuing A.I. with soul"', external: true },
  { href: '/labyrinth', label: 'The Labyrinth A.I. Chat' },
];

function isActive(href: string): boolean {
  if (href === '/') {
    return currentPath === '/';
  }
  if (href === '/portfolio') {
    return currentPath.startsWith('/portfolio');
  }
  return currentPath.startsWith(href);
}
---

<header class="header">
  <div class="container">
    <nav class="nav">
      <ul class="nav-links nav-left">
        {leftNav.map((link) => (
          <li class={link.hasDropdown ? 'nav-dropdown' : ''}>
            <a
              href={link.href}
              class:list={['nav-link', { 'is-active': !link.external && isActive(link.href) }]}
              target={link.external ? '_blank' : undefined}
              rel={link.external ? 'noopener noreferrer' : undefined}
            >
              {link.label}
              {link.hasDropdown && <span class="dropdown-arrow">&#9662;</span>}
            </a>
            {link.hasDropdown && link.dropdownKey === 'portfolio' && (
              <ul class="dropdown-menu">
                {portfolioItems.map((item) => (
                  <li>
                    <a href={item.href} class="dropdown-link">{item.label}</a>
                  </li>
                ))}
              </ul>
            )}
            {link.hasDropdown && link.dropdownKey === 'ai' && (
              <ul class="dropdown-menu">
                {aiItems.map((item) => (
                  <li>
                    <a
                      href={item.href}
                      class="dropdown-link"
                      target={item.external ? '_blank' : undefined}
                      rel={item.external ? 'noopener noreferrer' : undefined}
                    >{item.label}</a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))}
      </ul>

      <a href="/" class="nav-logo" aria-label="Minoan Mystery Home">
        <img src="/images/header-logo.png" alt="Tom di Mino" class="logo-img" />
        <!-- Lightning spark particles container -->
        <div class="spark-container" id="spark-container" aria-hidden="true"></div>
      </a>

      <ul class="nav-links nav-right">
        {rightNav.map((link) => (
          <li>
            <a
              href={link.href}
              class:list={['nav-link', { 'is-active': !link.external && isActive(link.href) }]}
              target={link.external ? '_blank' : undefined}
              rel={link.external ? 'noopener noreferrer' : undefined}
            >
              {link.label}
            </a>
          </li>
        ))}
        <li class="theme-toggle-wrapper">
          <ThemeToggle />
        </li>
      </ul>

      <button class="hamburger" id="hamburger" aria-label="Toggle menu" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </nav>
  </div>
</header>

<!-- Mobile Menu Overlay -->
<div class="mobile-menu-overlay" id="mobile-overlay"></div>

<!-- Mobile Menu Panel -->
<nav class="mobile-menu" id="mobile-menu">
  <ul class="mobile-nav-links">
    <li class="mobile-nav-item"><a href="/" class="mobile-nav-link">Home</a></li>
    <li class="mobile-nav-item"><a href="/about" class="mobile-nav-link">About</a></li>
    <li class="mobile-nav-item"><span class="mobile-nav-label">A.I./LLMs</span></li>
    <li class="mobile-nav-item"><a href="https://www.tomdimino.com/Cognitive-Designing-AI-LLMs.pdf" class="mobile-nav-link sublink" target="_blank" rel="noopener noreferrer">"Imbuing A.I. with soul"</a></li>
    <li class="mobile-nav-item"><a href="/labyrinth" class="mobile-nav-link sublink">The Labyrinth A.I. Chat</a></li>
    <li class="mobile-nav-item"><span class="mobile-nav-label">Portfolio</span></li>
    <li class="mobile-nav-item"><a href="/portfolio" class="mobile-nav-link sublink">View All</a></li>
    <li class="mobile-nav-item"><a href="/portfolio/czi" class="mobile-nav-link sublink">CZI</a></li>
    <li class="mobile-nav-item"><a href="/portfolio/acs" class="mobile-nav-link sublink">ACS</a></li>
    <li class="mobile-nav-item"><a href="/portfolio/dolby" class="mobile-nav-link sublink">Dolby</a></li>
    <li class="mobile-nav-item"><a href="/contact" class="mobile-nav-link">Contact</a></li>
    <li class="mobile-nav-item"><a href="https://tomdimino.substack.com/" class="mobile-nav-link" target="_blank" rel="noopener noreferrer">Blog</a></li>
  </ul>
  <div class="mobile-menu-footer">
    <div class="mobile-theme-toggle">
      <ThemeToggle />
      <span class="mobile-theme-label">Toggle theme</span>
    </div>
    <p class="mobile-menu-tagline">Don't be a mystery to your market.</p>
  </div>
</nav>

<style>
  .header {
    position: relative;
    z-index: 1000;
    background-color: var(--color-background);
    padding: 32px 0;
  }

  .nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 72px;
  }

  .nav-logo {
    display: flex;
    align-items: center;
    color: var(--color-text);
    transition: color var(--transition-fast);
    position: relative; /* For pseudo-element positioning */
  }

  .nav-logo:hover {
    opacity: 0.8;
  }

  .logo-img {
    height: 58px;
    width: auto;
    transition: opacity 0.3s ease;
    position: relative;
    z-index: 1; /* Keep main image crisp on top of glow */
  }

  .nav-logo:hover .logo-img {
    opacity: 0.85;
  }

  /* Edge-tracing glow effect - dark mode only
     PALPATINE FORCE LIGHTNING STYLE
     Primary glow: #60a5fa (electric blue)
     Secondary: #8b5cf6 (purple-violet)
     Core: #c4b5fd (light violet)
     Crackle: #93c5fd / #dbeafe (bright blue-white)
  */
  :global([data-theme='dark']) .nav-logo::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: 100%;
    background: url('/images/header-logo.png') center/contain no-repeat;
    /* Stacked drop-shadows - electric blue core with purple halo */
    filter: drop-shadow(0 0 2px #c4b5fd)
            drop-shadow(0 0 5px #60a5fa)
            drop-shadow(0 0 10px #8b5cf6)
            drop-shadow(0 0 18px rgba(96, 165, 250, 0.6))
            drop-shadow(0 0 25px rgba(139, 92, 246, 0.4));
    opacity: 0.6;
    z-index: 0;
    pointer-events: none;
    animation: logo-edge-glow 3s ease-in-out infinite;
  }

  /* Electric crackling effect - Sith lightning flicker */
  :global([data-theme='dark']) .nav-logo::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 130%;
    height: 130%;
    background: url('/images/header-logo.png') center/contain no-repeat;
    /* brightness(0) hides image, drop-shadows trace alpha edges */
    filter: brightness(0) saturate(0)
            drop-shadow(0 0 2px #fff)
            drop-shadow(0 0 4px #dbeafe)
            drop-shadow(0 0 6px #93c5fd)
            drop-shadow(0 0 10px #60a5fa);
    opacity: 0;
    z-index: 0;
    pointer-events: none;
    animation: logo-force-lightning 0.12s steps(3) infinite;
  }

  /* Breathing animation for base glow */
  @keyframes logo-edge-glow {
    0%, 100% {
      filter: drop-shadow(0 0 2px #c4b5fd)
              drop-shadow(0 0 4px #60a5fa)
              drop-shadow(0 0 8px #8b5cf6)
              drop-shadow(0 0 14px rgba(96, 165, 250, 0.5))
              drop-shadow(0 0 20px rgba(139, 92, 246, 0.3));
      opacity: 0.5;
    }
    50% {
      filter: drop-shadow(0 0 3px #c4b5fd)
              drop-shadow(0 0 6px #60a5fa)
              drop-shadow(0 0 12px #8b5cf6)
              drop-shadow(0 0 20px rgba(96, 165, 250, 0.7))
              drop-shadow(0 0 30px rgba(139, 92, 246, 0.5));
      opacity: 0.7;
    }
  }

  /* Force Lightning crackling - chaotic, electric flicker */
  @keyframes logo-force-lightning {
    0% {
      opacity: 0;
    }
    5% {
      opacity: 0.5;
      filter: drop-shadow(0 0 2px #fff)
              drop-shadow(0 0 4px #dbeafe)
              drop-shadow(0 0 6px #93c5fd)
              drop-shadow(0 0 10px #60a5fa);
    }
    8% {
      opacity: 0;
    }
    15% {
      opacity: 0.35;
      filter: drop-shadow(0 0 1px #fff)
              drop-shadow(0 0 3px #93c5fd)
              drop-shadow(0 0 5px #8b5cf6);
    }
    18% {
      opacity: 0;
    }
    35% {
      opacity: 0.45;
      filter: drop-shadow(0 0 2px #dbeafe)
              drop-shadow(0 0 5px #60a5fa)
              drop-shadow(0 0 8px #8b5cf6);
    }
    40% {
      opacity: 0;
    }
    55% {
      opacity: 0.3;
      filter: drop-shadow(0 0 1px #fff)
              drop-shadow(0 0 2px #93c5fd);
    }
    58% {
      opacity: 0;
    }
    75% {
      opacity: 0.55;
      filter: drop-shadow(0 0 3px #fff)
              drop-shadow(0 0 6px #dbeafe)
              drop-shadow(0 0 10px #60a5fa)
              drop-shadow(0 0 14px #8b5cf6);
    }
    80% {
      opacity: 0;
    }
    92% {
      opacity: 0.25;
      filter: drop-shadow(0 0 1px #dbeafe)
              drop-shadow(0 0 3px #60a5fa);
    }
    95%, 100% {
      opacity: 0;
    }
  }

  /* Hover state - UNLIMITED POWER */
  :global([data-theme='dark']) .nav-logo:hover::before {
    filter: drop-shadow(0 0 3px #fff)
            drop-shadow(0 0 6px #c4b5fd)
            drop-shadow(0 0 12px #60a5fa)
            drop-shadow(0 0 20px #8b5cf6)
            drop-shadow(0 0 30px rgba(96, 165, 250, 0.8))
            drop-shadow(0 0 40px rgba(139, 92, 246, 0.6));
    opacity: 0.85;
    animation: none;
  }

  /* Hover state - intense crackling */
  :global([data-theme='dark']) .nav-logo:hover::after {
    animation: logo-force-lightning-intense 0.08s steps(3) infinite;
  }

  /* Intense Force Lightning on hover */
  @keyframes logo-force-lightning-intense {
    0% {
      opacity: 0;
    }
    5% {
      opacity: 0.7;
      filter: drop-shadow(0 0 3px #fff)
              drop-shadow(0 0 6px #dbeafe)
              drop-shadow(0 0 10px #93c5fd)
              drop-shadow(0 0 16px #60a5fa);
    }
    10% {
      opacity: 0;
    }
    20% {
      opacity: 0.5;
      filter: drop-shadow(0 0 2px #fff)
              drop-shadow(0 0 5px #93c5fd)
              drop-shadow(0 0 8px #8b5cf6);
    }
    25% {
      opacity: 0;
    }
    40% {
      opacity: 0.65;
      filter: drop-shadow(0 0 4px #dbeafe)
              drop-shadow(0 0 8px #60a5fa)
              drop-shadow(0 0 14px #8b5cf6);
    }
    45% {
      opacity: 0;
    }
    60% {
      opacity: 0.45;
      filter: drop-shadow(0 0 2px #fff)
              drop-shadow(0 0 4px #93c5fd);
    }
    65% {
      opacity: 0;
    }
    80% {
      opacity: 0.75;
      filter: drop-shadow(0 0 4px #fff)
              drop-shadow(0 0 8px #dbeafe)
              drop-shadow(0 0 14px #60a5fa)
              drop-shadow(0 0 20px #8b5cf6);
    }
    85%, 100% {
      opacity: 0;
    }
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    :global([data-theme='dark']) .nav-logo::before {
      animation: none;
      filter: drop-shadow(0 0 3px #c9a0b8)
              drop-shadow(0 0 6px #c9a0b8)
              drop-shadow(0 0 10px #c9a0b8);
      opacity: 0.5;
    }
    :global([data-theme='dark']) .nav-logo::after {
      animation: none;
      opacity: 0;
    }
    :global([data-theme='dark']) .spark-container {
      display: none;
    }
  }

  /* ============================================
     LIGHTNING SPARK PARTICLES
     Flame-like particles that lick around edges
     ============================================ */
  .spark-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 140%;
    height: 140%;
    pointer-events: none;
    z-index: 2;
    overflow: visible;
    display: none; /* Hidden by default, shown in dark mode via JS */
  }

  :global([data-theme='dark']) .spark-container {
    display: block;
  }

  /* Individual spark particle */
  :global(.spark) {
    position: absolute;
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: #fff;
    box-shadow:
      0 0 2px #fff,
      0 0 4px #dbeafe,
      0 0 8px #60a5fa,
      0 0 12px #8b5cf6;
    opacity: 0;
    pointer-events: none;
  }

  /* Spark animation - flame-like licking motion */
  :global(.spark.spark-animate) {
    animation: spark-lick var(--spark-duration, 0.6s) ease-out forwards;
  }

  @keyframes spark-lick {
    0% {
      opacity: 0;
      transform: translate(0, 0) scale(0.5);
    }
    10% {
      opacity: 1;
      transform: translate(var(--spark-x1, 2px), var(--spark-y1, -4px)) scale(1);
    }
    30% {
      opacity: 0.9;
      transform: translate(var(--spark-x2, 4px), var(--spark-y2, -10px)) scale(0.9);
    }
    60% {
      opacity: 0.6;
      transform: translate(var(--spark-x3, 6px), var(--spark-y3, -18px)) scale(0.7);
    }
    100% {
      opacity: 0;
      transform: translate(var(--spark-x4, 8px), var(--spark-y4, -28px)) scale(0.3);
    }
  }

  /* Different spark sizes */
  :global(.spark-sm) {
    width: 2px;
    height: 2px;
    box-shadow:
      0 0 1px #fff,
      0 0 3px #93c5fd,
      0 0 6px #60a5fa;
  }

  :global(.spark-lg) {
    width: 6px;
    height: 6px;
    box-shadow:
      0 0 3px #fff,
      0 0 6px #dbeafe,
      0 0 12px #60a5fa,
      0 0 18px #8b5cf6;
  }

  /* Electric arc - thin lightning bolt shapes */
  :global(.spark-arc) {
    width: 2px;
    height: 12px;
    border-radius: 1px;
    background: linear-gradient(to top, transparent, #60a5fa, #fff, #60a5fa, transparent);
    box-shadow:
      0 0 4px #60a5fa,
      0 0 8px #8b5cf6;
  }

  :global(.spark-arc.spark-animate) {
    animation: arc-flicker var(--spark-duration, 0.4s) ease-out forwards;
  }

  @keyframes arc-flicker {
    0% {
      opacity: 0;
      transform: rotate(var(--arc-rotation, 0deg)) scaleY(0.3);
    }
    15% {
      opacity: 1;
      transform: rotate(var(--arc-rotation, 0deg)) scaleY(1);
    }
    40% {
      opacity: 0.8;
      transform: rotate(var(--arc-rotation, 0deg)) scaleY(1.2) translateY(-4px);
    }
    70% {
      opacity: 0.4;
      transform: rotate(var(--arc-rotation, 0deg)) scaleY(0.8) translateY(-8px);
    }
    100% {
      opacity: 0;
      transform: rotate(var(--arc-rotation, 0deg)) scaleY(0.2) translateY(-12px);
    }
  }

  .nav-links {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-left {
    flex: 1;
    justify-content: flex-start;
  }

  .nav-right {
    flex: 1;
    justify-content: flex-end;
  }

  .theme-toggle-wrapper {
    display: flex;
    align-items: center;
    margin-left: 8px;
  }

  .nav-link {
    position: relative;
    font-size: 18px;
    font-weight: 500;
    color: var(--color-text); /* Uses CSS variable for dark mode support */
    text-decoration: none;
    transition: color 0.35s ease; /* Matching Webflow 0.35s */
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 14px 20px; /* 44px touch target (14*2 + ~16px line-height) */
    min-height: 44px; /* WCAG 2.2 / Apple HIG minimum */
  }

  .dropdown-arrow {
    font-size: 1rem;
    opacity: 0.7;
    margin-left: 2px;
  }

  .nav-link::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 0;
    height: 1px;
    background-color: var(--color-primary);
    transition: width var(--transition-normal);
  }

  .nav-link:hover,
  .nav-link:active {
    color: var(--color-primary);
  }

  .nav-link:hover::after,
  .nav-link:focus-visible::after,
  .nav-link:active::after {
    width: 100%;
  }

  .nav-link.is-active {
    color: var(--color-text);
  }

  .nav-link.is-active::after {
    width: 100%;
    background-color: var(--color-text);
  }

  /* Dropdown menu */
  .nav-dropdown {
    position: relative;
  }

  /* Hide underline for dropdown triggers - dropdown appearance is the feedback */
  .nav-dropdown .nav-link::after {
    display: none;
  }

  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 260px;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    list-style: none;
    padding: var(--space-sm) 0;
    margin: 0;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all var(--transition-fast);
    z-index: 100;
  }

  .nav-dropdown:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-link {
    display: block;
    padding: 12px 16px; /* 44px touch target */
    min-height: 44px;
    color: var(--color-text);
    text-decoration: none;
    font-size: 18px;
    font-weight: 500;
    transition: background-color var(--transition-fast);
  }

  .dropdown-link:hover,
  .dropdown-link:active {
    background-color: var(--color-background-alt, #f5f5f5);
    color: var(--color-primary);
  }

  /* Hamburger button */
  .hamburger {
    display: none;
    flex-direction: column;
    justify-content: center;
    gap: 8px;
    width: 46px;
    height: 40px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    z-index: 1001;
  }

  .hamburger span {
    display: block;
    width: 46px;
    height: 2px;
    background-color: var(--color-text);
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  .hamburger.is-active span:nth-child(1) {
    transform: translateY(10px) rotate(45deg);
  }

  .hamburger.is-active span:nth-child(2) {
    opacity: 0;
  }

  .hamburger.is-active span:nth-child(3) {
    transform: translateY(-10px) rotate(-45deg);
  }

  .hamburger.is-active span {
    background-color: var(--color-text);
  }

  /* Mobile menu overlay - Editorial/Refined aesthetic */
  .mobile-menu {
    display: none;
    position: fixed;
    top: 0;
    right: -100%;
    width: 85%;
    max-width: 420px;
    height: 100vh;
    height: 100dvh; /* Dynamic viewport height for mobile */
    background-color: #0d0d0d;
    padding: 0;
    z-index: 999;
    transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow-y: auto;
    flex-direction: column;
  }

  .mobile-menu::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 1px;
    height: 100%;
    background: linear-gradient(
      to bottom,
      transparent 0%,
      var(--color-primary) 20%,
      var(--color-primary) 80%,
      transparent 100%
    );
    opacity: 0.6;
  }

  .mobile-menu.is-open {
    display: flex;
    right: 0;
  }

  .mobile-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background-color: rgba(13, 13, 13, 0.7);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 998;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.4s ease, visibility 0.4s ease;
  }

  .mobile-menu-overlay.is-open {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .mobile-nav-links {
    list-style: none;
    margin: 0;
    padding: 120px 48px 30px;
    display: flex;
    flex-direction: column;
    gap: 0;
    flex: 1;
  }

  .mobile-nav-item {
    opacity: 0;
    transform: translateX(20px);
  }

  .mobile-menu.is-open .mobile-nav-item {
    animation: slideInNav 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .mobile-menu.is-open .mobile-nav-item:nth-child(1) { animation-delay: 0.05s; }
  .mobile-menu.is-open .mobile-nav-item:nth-child(2) { animation-delay: 0.1s; }
  .mobile-menu.is-open .mobile-nav-item:nth-child(3) { animation-delay: 0.15s; }
  .mobile-menu.is-open .mobile-nav-item:nth-child(4) { animation-delay: 0.2s; }
  .mobile-menu.is-open .mobile-nav-item:nth-child(5) { animation-delay: 0.25s; }
  .mobile-menu.is-open .mobile-nav-item:nth-child(6) { animation-delay: 0.3s; }
  .mobile-menu.is-open .mobile-nav-item:nth-child(7) { animation-delay: 0.35s; }
  .mobile-menu.is-open .mobile-nav-item:nth-child(8) { animation-delay: 0.4s; }
  .mobile-menu.is-open .mobile-nav-item:nth-child(9) { animation-delay: 0.45s; }
  .mobile-menu.is-open .mobile-nav-item:nth-child(10) { animation-delay: 0.5s; }
  .mobile-menu.is-open .mobile-nav-item:nth-child(11) { animation-delay: 0.55s; }

  @keyframes slideInNav {
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .mobile-nav-link {
    display: block;
    font-size: 28px;
    font-weight: 500;
    letter-spacing: -0.02em;
    color: #fff;
    text-decoration: none;
    padding: 18px 0;
    position: relative;
    transition: color 0.3s ease, padding-left 0.3s ease;
  }

  .mobile-nav-link::before {
    content: '';
    position: absolute;
    left: -24px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 1px;
    background-color: var(--color-primary);
    transition: width 0.3s ease;
  }

  .mobile-nav-link:hover {
    color: var(--color-primary);
    padding-left: 8px;
  }

  .mobile-nav-link:hover::before {
    width: 16px;
  }

  .mobile-nav-link.sublink {
    font-size: 18px;
    font-weight: 500;
    padding: 12px 0 12px 24px;
    color: rgba(255, 255, 255, 0.5);
    letter-spacing: 0;
  }

  .mobile-nav-link.sublink::before {
    left: 0;
  }

  .mobile-nav-link.sublink:hover {
    color: #fff;
    padding-left: 32px;
  }

  .mobile-nav-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--color-primary);
    padding: 12px 0 8px;
    margin-top: 0;
  }

  /* Decorative footer in mobile menu */
  .mobile-menu-footer {
    padding: 0 48px 40px;
    padding-bottom: max(40px, env(safe-area-inset-bottom, 40px));
    flex-shrink: 0;
  }

  .mobile-menu-footer::before {
    content: '';
    display: block;
    width: 40px;
    height: 1px;
    background-color: rgba(255, 255, 255, 0.2);
    margin-bottom: 20px;
  }

  .mobile-menu-tagline {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.35);
    font-style: italic;
    letter-spacing: 0.02em;
  }

  .mobile-theme-toggle {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
  }

  /* Override theme toggle colors in dark mobile menu */
  .mobile-theme-toggle :global(.theme-toggle) {
    border-color: rgba(255, 255, 255, 0.3);
    color: #fff;
  }

  .mobile-theme-toggle :global(.theme-toggle:hover) {
    border-color: var(--color-primary);
  }

  .mobile-theme-label {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.5);
    font-weight: 500;
  }

  /* Tablet breakpoint - Priority+ pattern: collapse nav earlier */
  @media (max-width: 1024px) {
    .nav-link {
      padding: 12px 14px;
      font-size: 16px;
    }

    .dropdown-link {
      font-size: 16px;
    }

    .logo-img {
      height: 48px;
    }
  }

  /* Earlier hamburger on smaller tablets */
  @media (max-width: 900px) {
    .nav {
      justify-content: center;
    }

    .nav-left,
    .nav-right {
      display: none;
    }

    .nav-logo {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .logo-img {
      height: 58px;
    }

    .hamburger {
      display: flex;
      position: absolute;
      right: 24px;
    }

    .mobile-menu,
    .mobile-menu-overlay {
      display: block;
    }

    .dropdown-menu {
      display: none;
    }
  }

  /* Mobile breakpoint */
  @media (max-width: 768px) {
    .logo-img {
      height: 56px;
    }

    .hamburger {
      right: 16px;
    }
  }
</style>

<script>
  /**
   * Mobile Menu Controller
   *
   * Handles hamburger menu with proper View Transition cleanup.
   * Tracks event listeners to prevent accumulation across navigations.
   */
  (function() {
    // Track handlers for cleanup
    let hamburgerClickHandler: (() => void) | null = null;
    let overlayClickHandler: (() => void) | null = null;
    let linkClickHandlers: Array<{ el: Element; handler: () => void }> = [];
    let initialized = false;

    function initMobileMenu() {
      // Prevent multiple initializations
      if (initialized) return;

      const hamburger = document.getElementById('hamburger');
      const mobileMenu = document.getElementById('mobile-menu');
      const mobileOverlay = document.getElementById('mobile-overlay');

      if (!hamburger || !mobileMenu || !mobileOverlay) return;

      initialized = true;

      const closeMenu = () => {
        mobileMenu.classList.remove('is-open');
        mobileOverlay.classList.remove('is-open');
        hamburger.classList.remove('is-active');
        hamburger.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      };

      const toggleMenu = () => {
        const isOpen = mobileMenu.classList.toggle('is-open');
        mobileOverlay.classList.toggle('is-open');
        hamburger.classList.toggle('is-active');
        hamburger.setAttribute('aria-expanded', String(isOpen));
        document.body.style.overflow = isOpen ? 'hidden' : '';
      };

      // Track handlers for cleanup
      hamburgerClickHandler = toggleMenu;
      overlayClickHandler = closeMenu;

      hamburger.addEventListener('click', hamburgerClickHandler);
      mobileOverlay.addEventListener('click', overlayClickHandler);

      // Close menu when clicking a link (track each handler)
      mobileMenu.querySelectorAll('a').forEach(link => {
        const handler = () => closeMenu();
        linkClickHandlers.push({ el: link, handler });
        link.addEventListener('click', handler);
      });
    }

    function cleanupMobileMenu() {
      const hamburger = document.getElementById('hamburger');
      const mobileOverlay = document.getElementById('mobile-overlay');

      // Remove tracked listeners
      if (hamburger && hamburgerClickHandler) {
        hamburger.removeEventListener('click', hamburgerClickHandler);
      }
      if (mobileOverlay && overlayClickHandler) {
        mobileOverlay.removeEventListener('click', overlayClickHandler);
      }

      // Remove link click handlers
      linkClickHandlers.forEach(({ el, handler }) => {
        el.removeEventListener('click', handler);
      });

      // Reset state
      hamburgerClickHandler = null;
      overlayClickHandler = null;
      linkClickHandlers = [];
      initialized = false;
    }

    // Run on initial load
    initMobileMenu();

    // Cleanup before View Transition swap
    document.addEventListener('astro:before-swap', cleanupMobileMenu);

    // Re-run after View Transitions
    document.addEventListener('astro:after-swap', initMobileMenu);
  })();
</script>

<!-- Lightning Spark Particles Generator -->
<script>
  /**
   * Spark Particles Controller
   *
   * Generates lightning-like spark effects around the logo in dark mode.
   * Properly cleans up intervals, observers, and listeners on View Transitions.
   */
  (function() {
    let sparkInterval: ReturnType<typeof setInterval> | null = null;
    let isHovering = false;
    let observer: MutationObserver | null = null;
    let mouseEnterHandler: (() => void) | null = null;
    let mouseLeaveHandler: (() => void) | null = null;
    let currentNavLogo: Element | null = null;
    let initialized = false;

    function initSparkParticles() {
      // Prevent multiple initializations
      if (initialized) return;

      const container = document.getElementById('spark-container');
      const navLogo = document.querySelector('.nav-logo');
      if (!container || !navLogo) return;

      initialized = true;
      currentNavLogo = navLogo;

      // Check if dark mode and reduced motion
      const isDarkMode = () => document.documentElement.getAttribute('data-theme') === 'dark';
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      if (prefersReducedMotion) return;

      // Spark spawn positions around the logo perimeter (relative %)
      const spawnPoints = [
        // Top edge of letters
        { x: 20, y: 15 }, { x: 35, y: 10 }, { x: 50, y: 8 },
        { x: 65, y: 10 }, { x: 80, y: 15 },
        // Diagonal strokes
        { x: 25, y: 30 }, { x: 40, y: 45 }, { x: 60, y: 45 },
        { x: 75, y: 30 },
        // Bottom corners
        { x: 15, y: 70 }, { x: 30, y: 85 }, { x: 50, y: 90 },
        { x: 70, y: 85 }, { x: 85, y: 70 },
        // Side edges
        { x: 10, y: 40 }, { x: 90, y: 40 },
        { x: 12, y: 55 }, { x: 88, y: 55 },
      ];

      function createSpark() {
        if (!isDarkMode()) return;

        const spark = document.createElement('div');

        // Random spark type
        const sparkType = Math.random();
        if (sparkType < 0.7) {
          // Regular round spark
          const size = Math.random();
          spark.className = size < 0.4 ? 'spark spark-sm' : size < 0.85 ? 'spark' : 'spark spark-lg';
        } else {
          // Arc/bolt shape
          spark.className = 'spark spark-arc';
          spark.style.setProperty('--arc-rotation', `${Math.random() * 360}deg`);
        }

        // Random spawn position from predefined points
        const spawnPoint = spawnPoints[Math.floor(Math.random() * spawnPoints.length)];
        const jitterX = (Math.random() - 0.5) * 10;
        const jitterY = (Math.random() - 0.5) * 10;

        spark.style.left = `${spawnPoint.x + jitterX}%`;
        spark.style.top = `${spawnPoint.y + jitterY}%`;

        // Random flame-like movement direction (mostly upward with some lateral)
        const baseAngle = -90 + (Math.random() - 0.5) * 60; // -120 to -60 degrees (upward arc)
        const distance = 15 + Math.random() * 25;
        const rad = (baseAngle * Math.PI) / 180;

        // Calculate movement points along the path
        spark.style.setProperty('--spark-x1', `${Math.cos(rad) * distance * 0.2}px`);
        spark.style.setProperty('--spark-y1', `${Math.sin(rad) * distance * 0.2}px`);
        spark.style.setProperty('--spark-x2', `${Math.cos(rad) * distance * 0.5}px`);
        spark.style.setProperty('--spark-y2', `${Math.sin(rad) * distance * 0.5}px`);
        spark.style.setProperty('--spark-x3', `${Math.cos(rad) * distance * 0.75}px`);
        spark.style.setProperty('--spark-y3', `${Math.sin(rad) * distance * 0.75}px`);
        spark.style.setProperty('--spark-x4', `${Math.cos(rad) * distance}px`);
        spark.style.setProperty('--spark-y4', `${Math.sin(rad) * distance}px`);

        // Random duration
        const duration = isHovering ? 0.3 + Math.random() * 0.3 : 0.5 + Math.random() * 0.4;
        spark.style.setProperty('--spark-duration', `${duration}s`);

        container.appendChild(spark);

        // Trigger animation
        requestAnimationFrame(() => {
          spark.classList.add('spark-animate');
        });

        // Remove after animation
        setTimeout(() => {
          spark.remove();
        }, duration * 1000 + 100);
      }

      function startSparkLoop() {
        if (sparkInterval) return;

        // Base rate: spawn sparks periodically
        const spawnRate = isHovering ? 40 : 120; // ms between spawns
        sparkInterval = setInterval(() => {
          if (isDarkMode()) {
            createSpark();
            // Sometimes spawn multiple sparks at once for bursts
            if (Math.random() < (isHovering ? 0.5 : 0.2)) {
              setTimeout(createSpark, 20);
            }
            if (isHovering && Math.random() < 0.3) {
              setTimeout(createSpark, 40);
            }
          }
        }, spawnRate);
      }

      function stopSparkLoop() {
        if (sparkInterval) {
          clearInterval(sparkInterval);
          sparkInterval = null;
        }
      }

      // Hover handlers for intensified effect (tracked for cleanup)
      mouseEnterHandler = () => {
        isHovering = true;
        stopSparkLoop();
        startSparkLoop();
      };

      mouseLeaveHandler = () => {
        isHovering = false;
        stopSparkLoop();
        startSparkLoop();
      };

      navLogo.addEventListener('mouseenter', mouseEnterHandler);
      navLogo.addEventListener('mouseleave', mouseLeaveHandler);

      // Start the spark loop
      startSparkLoop();

      // Listen for theme changes
      observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.attributeName === 'data-theme') {
            if (!isDarkMode()) {
              stopSparkLoop();
            } else {
              startSparkLoop();
            }
          }
        });
      });
      observer.observe(document.documentElement, { attributes: true });
    }

    function cleanupSparkParticles() {
      // Stop spark interval
      if (sparkInterval) {
        clearInterval(sparkInterval);
        sparkInterval = null;
      }

      // Disconnect observer
      if (observer) {
        observer.disconnect();
        observer = null;
      }

      // Remove hover listeners
      if (currentNavLogo) {
        if (mouseEnterHandler) {
          currentNavLogo.removeEventListener('mouseenter', mouseEnterHandler);
        }
        if (mouseLeaveHandler) {
          currentNavLogo.removeEventListener('mouseleave', mouseLeaveHandler);
        }
      }

      // Reset state
      mouseEnterHandler = null;
      mouseLeaveHandler = null;
      currentNavLogo = null;
      isHovering = false;
      initialized = false;
    }

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSparkParticles, { once: true });
    } else {
      initSparkParticles();
    }

    // Cleanup before View Transition swap
    document.addEventListener('astro:before-swap', cleanupSparkParticles);

    // Re-init after View Transitions
    document.addEventListener('astro:after-swap', initSparkParticles);
  })();
</script>

