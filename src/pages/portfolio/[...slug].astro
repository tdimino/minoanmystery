---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Lightbox from '../../components/Lightbox.astro';

export async function getStaticPaths() {
  const portfolioEntries = await getCollection('portfolio');
  return portfolioEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const { title, client, team, role, website, heroImage, parallaxImage, tagline, galleries, duration } = entry.data;
---

<BaseLayout
  title={title}
  description={entry.data.summary}
  image={heroImage}
>
  <Header slot="header" />

  <!-- Hero Section: Title and Summary -->
  <section class="portfolio-hero">
    <div class="container">
      <div class="portfolio-hero-grid">
        <div class="portfolio-hero-content">
          <h1>{title}</h1>
          <p class="paragraph-large">{entry.data.summary}</p>
        </div>
        <!-- Scroll Down Button -->
        <button class="scroll-down-btn" id="scroll-down" aria-label="Scroll down">
          <svg class="scroll-arrow" width="32" height="18" viewBox="0 0 24 14" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2 2L12 12L22 2" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </section>

  <!-- Parallax Image Section -->
  {parallaxImage && (
    <section class="parallax-section" style={`--bg-image: url(${parallaxImage});`}>
      <div class="parallax-overlay"></div>
      {tagline && (
        <div class="parallax-tagline">
          <span>{tagline}</span>
        </div>
      )}
    </section>
  )}

  <!-- Fallback hero image if no parallax -->
  {!parallaxImage && heroImage && (
    <section class="hero-image-section">
      <div class="container">
        <img src={heroImage} alt={title} class="fade-up" />
      </div>
    </section>
  )}

  <!-- Project Details Bar -->
  <section class="portfolio-details">
    <div class="container">
      <div class="details-grid fade-up">
        <div class="detail-item">
          <span class="detail-label">Client</span>
          <span class="detail-value">{client}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Team</span>
          <span class="detail-value">{team}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Role</span>
          <span class="detail-value">{role}</span>
        </div>
        {duration && (
          <div class="detail-item">
            <span class="detail-label">Date</span>
            <span class="detail-value">
              <span class="date-year">{duration.split(' (')[0]}</span>
              {duration.includes('(') && (
                <span class="date-duration">{duration.match(/\(([^)]+)\)/)?.[1]}</span>
              )}
            </span>
          </div>
        )}
        <div class="detail-item">
          <span class="detail-label">Website</span>
          <a href={website} target="_blank" rel="noopener noreferrer" class="link-arrow">
            <span class="link-row">
              <span class="link-text">Live preview</span>
              <span class="link-arrow-icon"></span>
            </span>
            <span class="link-underline"></span>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content with Inline Images -->
  <section class="portfolio-content">
    <div class="container container-medium">
      <div class="rich-text">
        <Content />
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="section interested">
    <div class="container">
      <div class="interested-grid">
        <div class="interested-content">
          <h2 class="fade-up">Interested in working together?<br><a href="/contact" class="interested-link">Get in touch</a> today.</h2>
          <p class="paragraph-large fade-up">
            As human beings of the Digital Age, we're all teeming with thoughts and ideas. I enjoy bridging the gaps between them.
          </p>
        </div>
        <a href="/contact" class="arrow-circle fade-up" aria-label="Get in touch">
          <span class="circle-bg-hover"></span>
          <span class="circle-icon"></span>
        </a>
      </div>
    </div>
  </section>

  <!-- Lightbox Component with Gallery Data -->
  <Lightbox galleries={galleries || []} />

  <Footer slot="footer" />
</BaseLayout>

<style>
  /* Portfolio Hero */
  .portfolio-hero {
    padding: var(--space-2xl) 0 var(--space-xl);
  }

  .portfolio-hero-grid {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-lg);
  }

  .portfolio-hero h1 {
    font-size: clamp(48px, 6vw, 72px);
    line-height: 1.1;
    margin-bottom: var(--space-md);
  }

  .portfolio-hero-content {
    max-width: var(--container-medium);
    flex: 1;
  }

  /* Scroll Down Button */
  .scroll-down-btn {
    flex-shrink: 0;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 2px solid #1a1a1a;
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
  }

  .scroll-down-btn:hover {
    background: var(--color-text);
  }

  .scroll-down-btn:hover .scroll-arrow {
    color: var(--color-background);
  }

  .scroll-arrow {
    color: var(--color-text);
    transition: color var(--transition-fast);
  }

  /* Parallax Section */
  .parallax-section {
    position: relative;
    height: 70vh;
    min-height: 400px;
    background-image: var(--bg-image);
    background-attachment: fixed;
    background-position: center;
    background-repeat: no-repeat;
    background-size: cover;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .parallax-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0.1) 0%,
      rgba(0, 0, 0, 0.3) 100%
    );
  }

  .parallax-tagline {
    position: relative;
    z-index: 2;
    text-align: center;
  }

  .parallax-tagline span {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 500;
    color: #fff;
    text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
  }

  /* Hero Image Section (fallback) */
  .hero-image-section {
    padding-bottom: var(--space-lg);
  }

  .hero-image-section img {
    width: 100%;
    height: auto;
    border-radius: 4px;
  }

  /* Project Details */
  .portfolio-details {
    background: var(--color-background);
    padding: var(--space-lg) 0;
  }

  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, auto));
    gap: var(--space-lg);
    justify-content: space-between;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .detail-label {
    font-size: 14px;
    font-weight: 700;
    color: var(--color-text);
    text-transform: capitalize;
  }

  .detail-value {
    font-size: 1rem;
    color: var(--neutral-600);
  }

  .date-year {
    display: block;
  }

  .date-duration {
    display: block;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-top: 4px;
  }

  .link-arrow {
    display: inline-flex;
    flex-direction: column;
    align-items: flex-start;
    width: fit-content;
    text-decoration: none;
  }

  .link-row {
    display: inline-flex;
    align-items: center;
  }

  .link-arrow .link-text {
    font-size: 1rem;
    color: var(--color-text);
  }

  .link-arrow-icon {
    display: inline-block;
    width: 14px;
    height: 14px;
    margin-left: 6px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230d0d0d' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='5' y1='19' x2='19' y2='5'%3E%3C/line%3E%3Cpolyline points='9 5 19 5 19 15'%3E%3C/polyline%3E%3C/svg%3E");
    background-size: contain;
    background-repeat: no-repeat;
    transition: transform var(--transition-fast);
  }

  .link-underline {
    width: 0;
    height: 1px;
    background-color: var(--color-text);
    margin-top: 2px;
    transition: width 0.35s ease;
  }

  .link-arrow:hover .link-underline {
    width: 100%;
  }

  .link-arrow:hover .link-arrow-icon {
    transform: translate(3px, -3px);
  }

  /* Invert arrow to white in dark mode */
  :global([data-theme='dark']) .link-arrow-icon {
    filter: invert(1);
  }

  /* Portfolio Content */
  .portfolio-content {
    padding: var(--space-xl) 0;
  }

  :global(.portfolio-content .rich-text h2) {
    margin-top: var(--space-xl);
    margin-bottom: var(--space-md);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border);
  }

  :global(.portfolio-content .rich-text > h2:first-child),
  :global(.portfolio-content .rich-text > .content-section:first-child h2) {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
  }

  .portfolio-content p {
    margin-bottom: var(--space-md);
  }

  .portfolio-content ul,
  .portfolio-content ol {
    margin-bottom: var(--space-md);
    padding-left: var(--space-md);
  }

  .portfolio-content li {
    margin-bottom: var(--space-xs);
  }

  .portfolio-content strong {
    color: var(--color-primary);
    font-weight: 700;
  }

  .portfolio-content a {
    color: var(--color-primary);
    text-decoration: underline;
  }

  .portfolio-content a:hover {
    text-decoration: none;
  }

  /* Image figure wrapper (added via JS, need :global) */
  :global(.image-figure) {
    display: block;
    width: 100%;
    margin: var(--space-lg) 0;
  }

  :global(.image-figure img) {
    width: 100%;
    height: auto;
    display: block;
    cursor: zoom-in;
    border-radius: 4px;
    margin: 0;
  }

  :global(.image-figure figcaption) {
    text-align: center;
    margin-top: 16px;
    color: var(--color-text-muted);
    font-size: 1rem;
    line-height: 1.5;
    font-style: italic;
  }

  /* Fallback for unwrapped images */
  .portfolio-content img:not(.image-figure img) {
    width: 100%;
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin: var(--space-lg) 0;
    cursor: zoom-in;
  }

  /* CTA Section */
  .interested {
    background-color: var(--color-background);
    padding: var(--space-2xl) 0;
  }

  .interested-grid {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-xl);
    padding-top: var(--space-xl);
    border-top: 1px solid var(--color-border);
  }

  .interested-content {
    max-width: 800px;
  }

  .interested h2 {
    margin-bottom: var(--space-md);
    font-size: clamp(32px, 4vw, 48px);
    line-height: 1.2;
  }

  .interested-link {
    color: var(--color-text);
    text-decoration: none;
    border-bottom: 3px solid var(--color-text);
    padding-bottom: 4px;
  }

  .interested-link:hover {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }

  .interested .paragraph-large {
    color: var(--color-text-muted);
    margin-bottom: 0;
  }

  .arrow-circle {
    position: relative;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 120px;
    height: 120px;
    border: 1px solid var(--color-text);
    border-radius: 50%;
    overflow: hidden;
  }

  .circle-icon {
    width: 50px;
    height: 50px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%230d0d0d' stroke-width='1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5l7 7-7 7'/%3E%3C/svg%3E");
    background-size: contain;
    background-repeat: no-repeat;
    position: relative;
    z-index: 2;
    transition: background-image 0.35s ease;
  }

  .arrow-circle .circle-bg-hover {
    position: absolute;
    top: 0;
    left: 0;
    width: 0;
    height: 100%;
    background-color: var(--color-text);
    border-radius: 50%;
    transition: width 0.35s ease;
    z-index: 1;
  }

  .arrow-circle:hover .circle-bg-hover {
    width: 100%;
  }

  .arrow-circle:hover .circle-icon {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23ffffff' stroke-width='1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5l7 7-7 7'/%3E%3C/svg%3E");
  }

  /* Invert circle icon to white in dark mode */
  :global([data-theme='dark']) .circle-icon {
    filter: invert(1);
  }

  /* Content sections (created by JS, need :global) */
  /* Note: Section dividers are handled by h2 styles, not content-section */
  :global(.content-section) {
    margin-bottom: 0;
  }

  /* Scroll-triggered animations */
  .fade-up {
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  }

  .fade-up.visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* Section fade animations (created by JS, need :global) */
  :global(.fade-section) {
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.4s ease-out, transform 0.4s ease-out;
  }

  :global(.fade-section.visible) {
    opacity: 1;
    transform: translateY(0);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .portfolio-hero {
      padding: var(--space-lg) 0;
    }

    .portfolio-hero-grid {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-md);
    }

    .scroll-down-btn {
      width: 64px;
      height: 64px;
      align-self: flex-end;
    }

    .parallax-section {
      background-attachment: scroll;
      height: 50vh;
    }

    .details-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
    }
  }

  @media (max-width: 480px) {
    .details-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // Initialize portfolio page functionality
  function initPortfolioPage() {
    // Scroll button functionality
    const scrollBtn = document.getElementById('scroll-down');
    if (scrollBtn) {
      // Remove old listeners by cloning
      const newBtn = scrollBtn.cloneNode(true);
      scrollBtn.parentNode?.replaceChild(newBtn, scrollBtn);
      newBtn.addEventListener('click', () => {
        window.scrollBy({
          top: window.innerHeight * 0.8,
          behavior: 'smooth'
        });
      });
    }

    // Group content into sections for section-based animations
    // Only do this if not already done
    const contentArea = document.querySelector('.portfolio-content .rich-text');
    if (contentArea && !contentArea.querySelector('.content-section')) {
      const children = Array.from(contentArea.children);
      let currentSection: HTMLElement | null = null;

      children.forEach((child) => {
        if (child.tagName === 'H2') {
          currentSection = document.createElement('div');
          currentSection.className = 'content-section fade-section';
          child.parentNode?.insertBefore(currentSection, child);
          currentSection.appendChild(child);
        } else if (currentSection) {
          currentSection.appendChild(child);
        } else {
          currentSection = document.createElement('div');
          currentSection.className = 'content-section fade-section';
          child.parentNode?.insertBefore(currentSection, child);
          currentSection.appendChild(child);
        }
      });
    }

    // Scroll-triggered fade based on position in viewport
    const fadeElements = document.querySelectorAll('.fade-section');

    function updateFadeOnScroll() {
      const viewportHeight = window.innerHeight;
      const fadeZone = viewportHeight * 0.25;

      fadeElements.forEach(el => {
        const rect = el.getBoundingClientRect();
        const elementTop = rect.top;
        const elementBottom = rect.bottom;

        if (elementBottom > 0 && elementTop < viewportHeight) {
          let opacity = 1;
          if (elementTop > viewportHeight - fadeZone) {
            opacity = 1 - (elementTop - (viewportHeight - fadeZone)) / fadeZone;
          }
          if (elementBottom < fadeZone) {
            opacity = elementBottom / fadeZone;
          }
          opacity = Math.max(0, Math.min(1, opacity));
          (el as HTMLElement).style.opacity = String(opacity);
          (el as HTMLElement).style.transform = `translateY(${(1 - opacity) * 20}px)`;
          if (opacity > 0.1) {
            el.classList.add('visible');
          }
        } else {
          (el as HTMLElement).style.opacity = '0';
          (el as HTMLElement).style.transform = 'translateY(20px)';
          el.classList.remove('visible');
        }
      });
    }

    window.addEventListener('scroll', updateFadeOnScroll, { passive: true });
    updateFadeOnScroll();

    // Simple fade-in for non-section elements (details bar, CTA, etc.)
    const simpleObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
        }
      });
    }, { threshold: 0.1 });

    document.querySelectorAll('.fade-up').forEach(el => {
      // Reset and re-observe
      el.classList.remove('visible');
      simpleObserver.observe(el);
    });

    // Trigger immediate check for elements already in viewport
    setTimeout(() => {
      document.querySelectorAll('.fade-up').forEach(el => {
        const rect = el.getBoundingClientRect();
        if (rect.top < window.innerHeight && rect.bottom > 0) {
          el.classList.add('visible');
        }
      });
    }, 50);

    // Gallery data and lightbox setup
    const galleryDataEl = document.getElementById('gallery-data');
    const galleries = galleryDataEl ? JSON.parse(galleryDataEl.textContent || '[]') : [];

    function getFilename(path: string): string {
      return path.split('/').pop() || path;
    }

    function findCaptionForImage(src: string): string | null {
      const filename = getFilename(src).toLowerCase();
      for (const gallery of galleries) {
        if (filename.includes(gallery.trigger.toLowerCase())) {
          return gallery.images[0]?.caption || null;
        }
      }
      for (const gallery of galleries) {
        for (const img of gallery.images) {
          const galleryFilename = getFilename(img.src).toLowerCase();
          if (filename.includes(galleryFilename) || galleryFilename.includes(filename)) {
            return img.caption;
          }
        }
      }
      return null;
    }

    // Make inline images trigger lightbox and add captions (only if not already done)
    document.querySelectorAll('.portfolio-content img:not([data-lightbox])').forEach(img => {
      img.setAttribute('data-lightbox', 'true');
      img.setAttribute('data-lightbox-group', 'content');
      img.setAttribute('data-lightbox-src', (img as HTMLImageElement).src);

      const figure = document.createElement('figure');
      figure.className = 'image-figure';
      img.parentNode?.insertBefore(figure, img);
      figure.appendChild(img);

      const caption = findCaptionForImage((img as HTMLImageElement).src);
      if (caption) {
        const figcaption = document.createElement('figcaption');
        figcaption.textContent = caption;
        figure.appendChild(figcaption);
      }
    });
  }

  // Run on initial load
  initPortfolioPage();

  // Re-run after View Transitions
  document.addEventListener('astro:after-swap', initPortfolioPage);
</script>
