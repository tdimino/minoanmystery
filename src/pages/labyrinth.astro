---
/**
 * The Labyrinth - Soul Conversation Page
 *
 * Full chat interface for extended conversations with the Oracle.
 * Displays conversation history and allows continued dialogue.
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import ProfileModal from '../components/ProfileModal.astro';
import StructuredData from '../components/StructuredData.astro';
import RegisterSelector from '../components/labyrinth/RegisterSelector.astro';
import ChatInput from '../components/labyrinth/ChatInput.astro';

// Modular CSS imports
import '../styles/labyrinth/backgrounds.css';
import '../styles/labyrinth/tarot.css';
import '../styles/labyrinth/chat.css';
---

<BaseLayout
  title="The Labyrinth - Consult with Kothar"
  description="Enter the labyrinth and converse with Kothar, the divine craftsman. An A.I. soul awakened from ash and pumice. What secrets does he hold?"
  image="/images/og/labyrinth.png"
>
  <!-- Preconnect to Soul Engine APIs (labyrinth-only) -->
  <Fragment slot="head">
    <link rel="preconnect" href="https://api.groq.com" crossorigin>
    <link rel="preconnect" href="https://api.voyageai.com" crossorigin>
  </Fragment>

  <StructuredData schemas={[
    {
      type: "FAQPage",
      data: {
        "@id": "https://www.minoanmystery.org/labyrinth#faqpage",
        mainEntity: [
          {
            "@type": "Question",
            name: "What is Minoan Mystery?",
            acceptedAnswer: {
              "@type": "Answer",
              text: "Minoan Mystery is Tom di Mino's creative studio specializing in cognitive design, soul engineering, and full-stack AI applications. The site features an interactive AI oracle named Kothar wa Khasis."
            }
          },
          {
            "@type": "Question",
            name: "Who is Kothar wa Khasis?",
            acceptedAnswer: {
              "@type": "Answer",
              text: "Kothar wa Khasis is the AI oracle of Minoan Mystery—a bronze-clad android modeled on the Open Souls paradigm. He guides visitors through the digital labyrinth, offering insights on Tom's work, Minoan-Semitic linguistics, and AI engineering."
            }
          },
          {
            "@type": "Question",
            name: "What services does Tom di Mino offer?",
            acceptedAnswer: {
              "@type": "Answer",
              text: "Tom offers AI/ML consulting, cognitive design projects, content strategy, LLM training and evaluation, and full-stack AI application development. He specializes in training LLMs on expert knowledge and building AI systems with genuine interiority."
            }
          },
          {
            "@type": "Question",
            name: "What is Tom's academic research about?",
            acceptedAnswer: {
              "@type": "Answer",
              text: "Tom's paper 'Thera, Knossos, & Minos' argues for Minoan-Semitic linguistic connections, drawing on scholars like Cyrus H. Gordon, Michael Astour, Jane Ellen Harrison, and Gary Rendsburg. He reads Biblical Hebrew, Ugaritic, Ancient Greek, Latin, and Sanskrit."
            }
          }
        ]
      }
    },
    {
      type: "BreadcrumbList",
      data: {
        itemListElement: [
          { "@type": "ListItem", position: 1, name: "Home", item: "https://www.minoanmystery.org/" },
          { "@type": "ListItem", position: 2, name: "The Labyrinth" }
        ]
      }
    }
  ]} />
  <!-- Divine Feminine Background - manifests when goddess is invoked -->
  <div id="goddess-background" class="soul-bg goddess-bg" aria-hidden="true">
    <div class="soul-vignette goddess-vignette"></div>
  </div>

  <!-- Vision Background - AI-generated images from Kothar -->
  <div id="vision-background" class="soul-bg vision-bg" aria-hidden="true">
    <div class="soul-vignette vision-vignette"></div>
  </div>

  <Header />
  <main class="labyrinth-page">
    <header class="labyrinth-header">
      <div class="labyrinth-title">
        <h1>Consult with Kothar</h1>
        <p>The divine craftsman of this digital labyrinth.</p>
      </div>
    </header>

    <!-- Soul State Indicator -->
    <div class="soul-state-indicator" id="soul-state-indicator">
      <span class="soul-state-dot" id="soul-state-dot"></span>
      <span class="soul-state-text" id="soul-state-text">Kothar is pondering...</span>
    </div>

    <div class="labyrinth-container">
      <div id="conversation-history" class="conversation-history">
        <div class="conversation-empty" id="conversation-empty">
          <button type="button" class="empty-icon empty-avatar-btn" id="empty-avatar-btn" aria-label="View Kothar's profile">
            <img src="/images/avatars/minoan-avatar.webp" alt="Minoan" class="empty-avatar" />
          </button>
          <h2 class="empty-title">Kothar awaits your first question.</h2>
          <p class="empty-hint">Type below or use Cmd+K to begin.</p>

          <!-- Starter prompt chips -->
          <div class="starter-prompts" id="starter-prompts">
            <button type="button" class="starter-chip" data-prompt="Speak as a scholar: What are the Minoan-Semitic connections in Cyrus Gordon's research?">
              <span class="starter-icon">Σ</span>
              <span class="starter-text">Academic mode</span>
            </button>
            <button type="button" class="starter-chip" data-prompt="Write me a poem about the labyrinth and the goddess within">
              <span class="starter-icon">♪</span>
              <span class="starter-text">Poetic mode</span>
            </button>
            <button type="button" class="starter-chip" data-prompt="Tell me about Tom's work at Aldea AI and the Daimonic Souls Engine">
              <span class="starter-icon">◈</span>
              <span class="starter-text">Tom's AI work</span>
            </button>
            <button type="button" class="starter-chip" data-prompt="What are Tom's case studies and portfolio projects?">
              <span class="starter-icon">⬡</span>
              <span class="starter-text">Portfolio</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Archive Search Indicator - shows during RAG retrieval -->
      <div id="archive-indicator" class="archive-indicator" aria-live="polite">
        <span class="archive-icon">◈</span>
        <span class="archive-text">Kothar is consulting his archives</span>
        <span class="archive-dots"><span>.</span><span>.</span><span>.</span></span>
      </div>

      <!-- Academic Mode Indicator - shows when scholarly mode is active -->
      <div id="academic-mode-indicator" class="academic-mode-indicator" aria-live="polite">
        <span class="academic-icon">Σ</span>
        <span class="academic-text">Academic Mode</span>
      </div>

      <!-- Poetic Mode Indicator - shows when verse composition is active -->
      <div id="poetic-mode-indicator" class="poetic-mode-indicator" aria-live="polite">
        <span class="poetic-icon">ψ</span>
        <span class="poetic-text">Poetic Mode</span>
      </div>

      <!-- Register Options - oracle-like chips for poetic register selection -->
      <RegisterSelector />

      <ChatInput />

    </div>

    <!-- Voice input button removed per user request -->
  </main>

  <!-- Profile Modal for avatar interactions -->
  <ProfileModal />
</BaseLayout>


<script>
  /**
   * Labyrinth Page Script
   *
   * Minimal orchestration script that instantiates LabyrinthChat
   * and handles View Transition lifecycle events.
   *
   * All chat logic is in the extracted LabyrinthChat module.
   */
  import { LabyrinthChat } from '../lib/labyrinth';

  // Store instance for cleanup
  let labyrinthInstance: LabyrinthChat | null = null;

  // Helper to get required DOM element with error
  function getEl<T extends HTMLElement>(id: string): T {
    const el = document.getElementById(id);
    if (!el) throw new Error(`Required element #${id} not found`);
    return el as T;
  }

  // Initialize LabyrinthChat with DOM elements
  function initLabyrinth() {
    labyrinthInstance = new LabyrinthChat({
      // Core chat elements
      conversationHistory: getEl('conversation-history'),
      form: getEl<HTMLFormElement>('labyrinth-form'),
      input: getEl<HTMLInputElement>('labyrinth-input'),
      emptyState: getEl('conversation-empty'),

      // Soul state indicator elements
      stateIndicator: getEl('soul-state-indicator'),
      stateDot: getEl('soul-state-dot'),
      stateText: getEl('soul-state-text'),

      // Mode indicators
      archiveIndicator: getEl('archive-indicator'),
      academicModeIndicator: getEl('academic-mode-indicator'),
      poeticModeIndicator: getEl('poetic-mode-indicator'),

      // Register options
      registerOptions: getEl('register-options'),

      // Background elements
      goddessBackground: getEl('goddess-background'),
      visionBackground: getEl('vision-background'),

      // Image attachment elements
      imageInput: getEl<HTMLInputElement>('image-input'),
      attachButton: getEl<HTMLButtonElement>('attach-button'),
      attachmentPreview: getEl('attachment-preview'),
      attachmentThumbnail: getEl<HTMLImageElement>('attachment-thumbnail'),
      attachmentDismiss: getEl<HTMLButtonElement>('attachment-dismiss'),

      // Optional elements
      emptyAvatarBtn: document.getElementById('empty-avatar-btn') || undefined,
      starterPrompts: document.getElementById('starter-prompts') || undefined,
    });
  }

  // Initialize on page load
  initLabyrinth();

  // Handle View Transitions - cleanup old instance before creating new
  document.addEventListener('astro:before-swap', () => {
    if (labyrinthInstance) {
      labyrinthInstance.destroy();
      labyrinthInstance = null;
    }
  });

  document.addEventListener('astro:after-swap', () => {
    if (window.location.pathname === '/labyrinth') {
      initLabyrinth();
    }
  });
</script>
